# Authentication 

As a user, I want to be able to create an account and login because it will
allow me to have ownership of my papers, comments, and votes.

As a developer, I want to use an authentication and authorization system to
ensure users may only perform the actions they are allowed to.

## Background and Description
*On a high level, what do we want to achieve? Why are we doing it and what
related things have we done before?*

We need to create the authentication and authorization system so that we can
allow users to create accounts and login.  This will allow them to post paper
drafts, to give reviews, to accept reviews and publish their papers, to post
paper responses, and to vote on papers. It will allow us to ensure users can
only perform the actions they are allowed to.

This is generally one of the first things we need to create when starting a new
web app.

## Acceptance Criteria
*How will we know when the milestone has been achieved?  These should be
verifiable, testable statements.*

- Users can register themselves with a name, email, and password.
    - Users are asked to confirm their password and rejected if the passwords don't match.
    - Emails are validated and rejected if they are not valid emails.
    - Attempts to register are rejected if a user with that email already exists.
    - Passwords are validated and rejected if they aren't strong enough (based solely on length).
    - Users are sent an email with a link to a token endpoint to confirm their email.
- Registered users can login using their email and password.
    - Registered users can request a password reset, and are sent a link with a token to allow them to reset.
- Users can view their profile.
    - Users viewing their own profile are shown an edit button.
- Users can edit their profile.
    - Users can change their name.
    - Users must confirm their password to change their email or password.
    - Users changing their email must verify their email ownership by being sent a token.
- Users are presented with links to login and register in the main navigation when not logged in.
- Users are presented with links to view their profile and logout in the main navigation when logged in.
- Users who are logged in may log out.

## What do we need to do?
*Here's where you can brainstorm and document what we need to do to achieve
this milestone and how we can go about doing it.*

### Users API
First, we'll need to define the **Users API**.

We'll start by defining the `user` object:

```js
{
    id: integer, // The unique identifier of the user.
    name: string, // The user's name.
    email: string, // The user's email, used as a login credential.
    password: string // The user's password, used as a login credential.  Never sent to the frontend.
}
```

> **NOTE**: We'll use "fully populated" to refer to a `user` object that has all of the
> above fields populated.  We'll use "populated" to refer to a `user` object that
> has the appropriate set of fields for the context (for example, if
> being returned from the backend, the `password` will be missing or if being
> POSTed from the frontend, the `id` field will be missing).  We'll use
> "partially populated" to refer to a `user` object missing one or more fields. 

Then we need to define the end points.  We'll use the verbs `GET`, `POST`,
`PUT`, `PATCH`, and `DELETE` with both the singular and plural endpoints.
Unless otherwise noted, the request body and return will be `json`.

#### `/users` Endpoint

> **NOTE**: The user's password hash should **never** be returned from any of
> this endpoints.  It should be stripped out from all `users` returned in
> responses.

`GET /users`: 

**Request**: No body.

**Response**: All users in the database as an array containing populated `user`
objects.

**Authorization**: Anyone.

`POST /users`:

**Request**: One or more populated `user` objects in an array. The `id`
field **may not** be populated.

**Action**: Adds the posted users to the database as new users.  They will be
assigned autogenerated id numbers.

**Response**: The newly added user(s) with `id` populated, as an array
containing `user` objects.

**Authorization**: If no user is logged in, then the request is limited to a
single user.  Admin users may submit multiple users.

`PUT /users`:

**Request**: One or more populated `user` objects in an array.  The
`id` field **may** be populated.

**Action**: Adds the users in the request body to the database.  If the `id`
field is populated, will replace users on that id.  Otherwise, creates new
users. 

**Response**: The newly added user(s) with `id` populated, as an array
containing `user` objects.

**Authorization**: User must be logged in.  Admin users may submit an arbitrary
number of users.  Other users may only submit a single user, and it must be
themselves.

`PATCH /users`:

**Request**: One or more partially populated `user` objects in an array.  The `id`
field **must** be populated.

**Action**: Merges the fields in the provided `user` objects with those populated
in the database, overwriting the database. 

**Response**: The modified `user` objects, fully populated, in an array.

**Authorization**: Users must be logged in.  Non-admin users may only submit a
single user, and it must be themselves.  Admin users may submit an arbitrary
numbers of users.

`DELETE /users`: 

**Request**: One or more partially populated `user` objects in an array.  The
`id` field **must** be populated and is the only field that is required.  The
other fields are ignored.

**Action**: Deletes the provided users from the database.

**Response**: Returns an array containing the `id` numbers of the deleted
users.

**Authorization**: User must be logged in.  Non-admin users may only submit a
single user and it must be themselves.  Admin users may submit an arbitrary
number of users.

#### `/user/:id` Endpoint

> **NOTE**: The user's password hash should **never** be returned from any of
> this endpoints.  It should be stripped out from all `users` returned in
> responses.

`GET /user/:id`: 

**Request**: No body.

**Response**: Populated `user` object matching `:id`, or `404 Not Found`. 

**Authorization**: Anyone.

`POST /user/:id`:

**Request**: A populated `user` object. 

**Action**: Synonym for `PUT /user/:id`. Overwrites the user in the database
identified by `:id` with the provided `user` object. 

**Response**: The modified `user` object, populated.

**Authorization**:  Anyone. 

`PUT /user/:id`:

**Request**: A populated `user` object.

**Action**:  Synonym for `POST /user/:id`. Overwrites the user identified by `:id` with the `user` object provided. 

**Response**: The modified `user` object, populated. 

**Authorization**: User must be logged in. Non-admin users may only modify
themselves. Admin users may modify any user.

`PATCH /user/:id`:

**Request**: A partially populated `user` object in an array. 

**Action**: Merges the fields in the provided `user` object with those populated
in the database as identified by `:id`, overwriting the database. 

**Response**: The modified `user` object, populated.

**Authorization**: Users must be logged in.  Non-admin users may only modify
themselves.  Admin users may modify anyone. 

`DELETE /user/:id`: 

**Request**: No body. 

**Action**: Deletes the user identified by `:id` from the database.

**Response**: An object containing only the `id` number of the user deleted. 

**Authorization**: User must be logged in. Non-admin users may only delete
themselves.  Admin users may delete any user.

### Authentication API

We're also going to need to define the **Authentication API**.

#### '/authentication` Endpoint

`GET /authentication`: 

**Request**: No body.

**Action**: No action.

**Response**: Populated `user` object from the user session, representing the currently authenticated user. 

**Authorization**: Anyone.

`POST /authentication`:

**Request**: An object containing the user's credentials (email and password). 

**Action**: Authenticates the user against the database, and on successful
authentication, creates the session and populates it with the `user` object for
the user. 

**Response**: The populated `user` object from the user session, representing the currently authenticated user. 

**Authorization**: Anyone.

`DELETE /authentication`:

**Request**: No body. 

**Action**:  Destroys the current user session. 

**Response**: Empty response. 

**Authorization**: User must be logged in.


## How should we break up the work?
*Break the work up into small, clearly scoped, releasable stories.*
